<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Northwoods Events – Parse Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --fg:#111; --muted:#666; --bg:#fff; --line:#ddd; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
    header{padding:16px 12px;border-bottom:1px solid var(--line);}
    header h1{margin:0 0 6px 0;font-size:18px;}
    header .links a{margin-right:12px}
    .wrap{padding:12px;max-width:1200px;margin:0 auto;}
    .panel{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
    .panel label{font-size:12px;color:var(--muted);display:block}
    .panel input,.panel select{padding:6px 8px;border:1px solid var(--line);border-radius:6px;min-width:160px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:8px 6px;vertical-align:top}
    th{font-size:12px;text-align:left;color:var(--muted)}
    tbody tr:hover{background:#fafafa}
    .muted{color:var(--muted)}
    .nowrap{white-space:nowrap}
    .right{margin-left:auto}
    .bad{color:#b20000}
    .pill{display:inline-block;border:1px solid var(--line);padding:1px 6px;border-radius:999px;font-size:12px}
    .pager{display:flex;align-items:center;gap:8px;margin-top:10px}
    button{padding:6px 10px;border:1px solid var(--line);background:#f6f6f6;border-radius:6px;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    details summary{cursor:pointer}
    code{background:#f6f6f6;padding:1px 4px;border-radius:4px}
  </style>
</head>
<body>
  <header>
    <h1>Northwoods Events – Parse Viewer</h1>
    <div class="links">
      <a id="lnk-report" href="#">last_run_report.json</a>
      <a id="lnk-events" href="#">events.json</a>
      <a id="lnk-ics" href="#">northwoods.ics</a>
    </div>
    <div id="summary" class="muted">Loading summary…</div>
  </header>

  <div class="wrap">
    <div class="panel">
      <div>
        <label for="q">Search (title/location)</label>
        <input id="q" type="search" placeholder="eg. craft fair, st. germain">
      </div>
      <div>
        <label for="srcSel">Source</label>
        <select id="srcSel"><option value="">All sources</option></select>
      </div>
      <div>
        <label for="from">From (start)</label>
        <input id="from" type="date">
      </div>
      <div>
        <label for="to">To (start)</label>
        <input id="to" type="date">
      </div>
      <div>
        <label for="pageSize">Rows per page</label>
        <select id="pageSize">
          <option>25</option>
          <option selected>50</option>
          <option>100</option>
          <option>200</option>
        </select>
      </div>
      <div class="right">
        <label>&nbsp;</label>
        <button id="resetBtn" type="button">Reset filters</button>
      </div>
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th>Title</th>
          <th class="nowrap">Start</th>
          <th class="nowrap">End</th>
          <th>All-day</th>
          <th>Location</th>
          <th>Source</th>
        </tr>
      </thead>
      <tbody><tr><td colspan="6" class="muted">Loading events…</td></tr></tbody>
    </table>

    <div class="pager">
      <button id="prevBtn" disabled>Prev</button>
      <span id="pageInfo" class="muted"></span>
      <button id="nextBtn" disabled>Next</button>
      <span id="counts" class="pill"></span>
    </div>

    <details style="margin-top:12px">
      <summary>What am I seeing?</summary>
      <div class="muted" style="margin-top:6px">
        This page reads <code>state/last_run_report.json</code> and <code>state/events.json</code> from the Pages artifact and renders a simple table.
        Times are shown in your browser’s local timezone; the raw ISO timestamps are in tooltips.
      </div>
    </details>

    <div id="errorBox" class="bad" style="margin-top:10px"></div>
  </div>

  <script>
    (function(){
      // Compute the project root path (works on user.github.io/<repo>/…)
      const ROOT = (function(){
        const p = location.pathname;
        return p.endsWith('/') ? p : p.replace(/\/[^\/]*$/, '/');
      })();
      const urls = {
        report: ROOT + 'state/last_run_report.json',
        events: ROOT + 'state/events.json',
        ics:    ROOT + 'ics/northwoods.ics'
      };

      // Wire the top links to absolute repo paths
      document.getElementById('lnk-report').href = urls.report;
      document.getElementById('lnk-events').href = urls.events;
      document.getElementById('lnk-ics').href = urls.ics;

      const els = {
        summary: document.getElementById('summary'),
        q: document.getElementById('q'),
        srcSel: document.getElementById('srcSel'),
        from: document.getElementById('from'),
        to: document.getElementById('to'),
        pageSize: document.getElementById('pageSize'),
        resetBtn: document.getElementById('resetBtn'),
        tblBody: document.querySelector('#tbl tbody'),
        prevBtn: document.getElementById('prevBtn'),
        nextBtn: document.getElementById('nextBtn'),
        pageInfo: document.getElementById('pageInfo'),
        counts: document.getElementById('counts'),
        error: document.getElementById('errorBox'),
      };

      let all = [];
      let view = [];
      let page = 1;

      function fmt(dtIso){
        if(!dtIso) return '';
        const d = new Date(dtIso);
        return d.toLocaleString();
      }

      function setSummary(r){
        if(!r || !r.totals){ els.summary.textContent = 'No summary available.'; return; }
        const when = r.when ? new Date(r.when).toLocaleString() : '';
        els.summary.innerHTML =
          'Run time: <b>'+when+'</b> '+
          '• Total parsed: <b>'+r.totals.parsed+'</b> '+
          '• Added: <b>'+r.totals.added+'</b> '+
          '• Store size: <b>'+r.totals.store_size+'</b>';
      }

      function uniqueSources(items){
        const s = new Set();
        for(const e of items){ if(e && e.source) s.add(e.source); }
        return Array.from(s).sort((a,b)=>a.localeCompare(b));
      }

      function normalize(e){
        // tolerate slightly different shapes
        return {
          title: e.title || e.name || '',
          start_iso: e.start_iso || e.start || e.startTime || '',
          end_iso: e.end_iso || e.end || e.endTime || '',
          all_day: !!(e.all_day ?? e.allDay),
          location: e.location || e.venue || '',
          source: e.source || e.source_name || '',
          url: e.url || e.link || ''
        };
      }

      function applyFilters(){
        const q = els.q.value.trim().toLowerCase();
        const src = els.srcSel.value;
        const from = els.from.value ? new Date(els.from.value+'T00:00:00') : null;
        const to = els.to.value ? new Date(els.to.value+'T23:59:59') : null;

        view = all.filter(e=>{
          if(src && e.source !== src) return false;
          const starts = e.start_iso ? new Date(e.start_iso) : null;
          if(from && starts && starts < from) return false;
          if(to && starts && starts > to) return false;
          if(q){
            const hay = ((e.title||'')+' '+(e.location||'')).toLowerCase();
            if(!hay.includes(q)) return false;
          }
          return true;
        }).sort((a,b)=>{
          const da = a.start_iso ? Date.parse(a.start_iso) : 0;
          const db = b.start_iso ? Date.parse(b.start_iso) : 0;
          return da - db;
        });

        page = 1;
        render();
      }

      function render(){
        const size = parseInt(els.pageSize.value,10) || 50;
        const total = view.length;
        const pages = Math.max(1, Math.ceil(total / size));
        if(page > pages) page = pages;

        const startIdx = (page - 1) * size;
        const endIdx = Math.min(startIdx + size, total);
        const slice = view.slice(startIdx, endIdx);

        els.tblBody.innerHTML = slice.map(e=>{
          const title = e.title ? e.title.replace(/</g,'&lt;') : '';
          const url = e.url ? e.url : null;
          const startT = e.start_iso ? fmt(e.start_iso) : '';
          const endT = e.end_iso ? fmt(e.end_iso) : '';
          const allDay = e.all_day ? 'Yes' : '';
          const where = e.location ? e.location.replace(/</g,'&lt;') : '';
          const source = e.source ? e.source.replace(/</g,'&lt;') : '';

          const titleHtml = url ? '<a href="'+url+'">'+title+'</a>' : title;
          const startHtml = e.start_iso ? '<span title="'+e.start_iso+'">'+startT+'</span>' : '';
          const endHtml = e.end_iso ? '<span title="'+e.end_iso+'">'+endT+'</span>' : '';

          return '<tr>'
            + '<td>'+titleHtml+'</td>'
            + '<td class="nowrap">'+startHtml+'</td>'
            + '<td class="nowrap">'+endHtml+'</td>'
            + '<td>'+allDay+'</td>'
            + '<td>'+where+'</td>'
            + '<td>'+source+'</td>'
            + '</tr>';
        }).join('') || '<tr><td colspan="6" class="muted">No events match your filters.</td></tr>';

        els.prevBtn.disabled = (page<=1);
        els.nextBtn.disabled = (page>=pages);
        els.pageInfo.textContent = 'Page '+page+' of '+pages;
        els.counts.textContent = total+' event(s)';
      }

      function resetFilters(){
        els.q.value='';
        els.srcSel.value='';
        els.from.value='';
        els.to.value='';
        page = 1;
        applyFilters();
      }

      els.q.addEventListener('input', applyFilters);
      els.srcSel.addEventListener('change', applyFilters);
      els.from.addEventListener('change', applyFilters);
      els.to.addEventListener('change', applyFilters);
      els.pageSize.addEventListener('change', render);
      els.resetBtn.addEventListener('click', resetFilters);
      els.prevBtn.addEventListener('click', ()=>{ page=Math.max(1,page-1); render(); });
      els.nextBtn.addEventListener('click', ()=>{ page=page+1; render(); });

      function bust(u){ return u + (u.includes('?') ? '&' : '?') + 't=' + Date.now(); }

      Promise.all([
        fetch(bust(urls.report), {cache:'no-store'}).then(r=>r.ok?r.json():null).catch(()=>null),
        fetch(bust(urls.events), {cache:'no-store'}).then(async r=>{
          if(!r.ok) throw new Error('HTTP '+r.status+' '+r.statusText);
          const j = await r.json();
          return Array.isArray(j) ? j : (Array.isArray(j.events) ? j.events : []);
        })
      ]).then(([report, events])=>{
        setSummary(report);
        all = (events || []).map(normalize);
        const opts = uniqueSources(all).map(s=>'<option>'+s.replace(/</g,'&lt;')+'</option>').join('');
        els.srcSel.insertAdjacentHTML('beforeend', opts);
        applyFilters();
      }).catch(err=>{
        els.tblBody.innerHTML = '<tr><td colspan="6" class="bad">Failed to load events.json</td></tr>';
        els.error.textContent = 'Error loading events.json: ' + (err && err.message ? err.message : err);
      });
    })();
  </script>
</body>
</html>
