<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Northwoods Events</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
  header { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 12px; }
  #status { padding: 8px 10px; background: #f6f8fa; border: 1px solid #d0d7de; border-radius: 6px; }
  label { font-weight: 600; margin-right: 6px; }
  select, input { padding: 6px; }
  table { border-collapse: collapse; width: 100%; margin-top: 12px; }
  th, td { border: 1px solid #d0d7de; padding: 8px; vertical-align: top; }
  th { background: #f6f8fa; text-align: left; }
  tfoot td { font-size: 12px; color: #57606a; }
  .muted { color: #57606a; }
  .wrap { word-break: break-word; }
</style>
</head>
<body>
<header>
  <div id="status">Loading…</div>
  <div>
    <label for="sourceSelect">Source</label>
    <select id="sourceSelect" aria-label="Filter by source">
      <option value="*">All sources</option>
    </select>
  </div>
  <div>
    <label for="q">Search</label>
    <input id="q" type="search" placeholder="title or location">
  </div>
  <div class="muted">Download: <a href="ics/northwoods.ics">northwoods.ics</a></div>
</header>

<table id="eventsTable" aria-describedby="status">
  <thead>
    <tr>
      <th style="width: 16ch;">Start</th>
      <th style="width: 16ch;">End</th>
      <th>Title</th>
      <th style="width: 28ch;">Location</th>
      <th style="width: 28ch;">Source</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr><td colspan="5" class="muted">Times shown in America/Chicago (local).</td></tr>
  </tfoot>
</table>

<script>
(function () {
  "use strict";

  var statusEl = document.getElementById("status");
  var tableBody = document.querySelector("#eventsTable tbody");
  var sourceSelect = document.getElementById("sourceSelect");
  var qInput = document.getElementById("q");

  var allEvents = [];
  var tz = "America/Chicago";

  function setStatus(msg) {
    statusEl.textContent = msg;
  }

  function fmt(dt) {
    if (!dt) return "";
    try {
      var d = new Date(dt);
      if (String(d) === "Invalid Date") return dt;
      return d.toLocaleString("en-US", {
        timeZone: tz,
        year: "numeric", month: "short", day: "2-digit",
        hour: "2-digit", minute: "2-digit"
      });
    } catch (e) { return dt; }
  }

  function uniqueSources(events) {
    var seen = {};
    var list = [];
    for (var i = 0; i < events.length; i++) {
      var s = (events[i].source || "").trim();
      if (!s) continue;
      if (!seen[s]) { seen[s] = true; list.push(s); }
    }
    list.sort(function(a,b){ return a.localeCompare(b); });
    return list;
  }

  function applyFilters() {
    var sel = sourceSelect.value;
    var q = qInput.value.trim().toLowerCase();
    var rows = [];
    var shown = 0;

    // Filter + sort by start date (missing dates sorted last)
    var data = allEvents.slice().sort(function(a, b) {
      var A = a.start_iso ? Date.parse(a.start_iso) : Infinity;
      var B = b.start_iso ? Date.parse(b.start_iso) : Infinity;
      return A - B;
    });

    for (var i = 0; i < data.length; i++) {
      var ev = data[i];
      if (sel !== "*" && (ev.source || "") !== sel) continue;

      if (q) {
        var hay = ((ev.title || "") + " " + (ev.location || "")).toLowerCase();
        if (hay.indexOf(q) === -1) continue;
      }

      var title = ev.title || "Untitled";
      var url = ev.url || "";
      var titleHtml = url ? '<a href="' + url + '">' + escapeHtml(title) + '</a>' : escapeHtml(title);

      rows.push(
        "<tr>" +
          "<td>" + escapeHtml(fmt(ev.start_iso)) + "</td>" +
          "<td>" + escapeHtml(fmt(ev.end_iso || "")) + "</td>" +
          "<td class='wrap'>" + titleHtml + "</td>" +
          "<td class='wrap'>" + escapeHtml(ev.location || "") + "</td>" +
          "<td class='wrap'>" + escapeHtml(ev.source || "") + "</td>" +
        "</tr>"
      );
      shown++;
    }

    tableBody.innerHTML = rows.join("");
    setStatus("Events shown: " + shown + " of " + allEvents.length);
  }

  function populateSources() {
    var sources = uniqueSources(allEvents);
    // Clear (keep the first "All sources")
    sourceSelect.options.length = 1;
    for (var i = 0; i < sources.length; i++) {
      var opt = document.createElement("option");
      opt.value = sources[i];
      opt.textContent = sources[i];
      sourceSelect.appendChild(opt);
    }
    // If ?source=... present in URL, select it if available
    var params = new URLSearchParams(location.search);
    var s = params.get("source");
    if (s) {
      for (var j = 0; j < sourceSelect.options.length; j++) {
        if (sourceSelect.options[j].value === s) {
          sourceSelect.selectedIndex = j;
          break;
        }
      }
    }
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, function (c) {
      return ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" })[c];
    });
  }

  // Try to fetch from a few safe, repo-aware paths
  function guessPaths() {
    // index.html is at /<repo>/index.html, so relative "state/events.json" is normally enough.
    var candidates = ["state/events.json"];

    // Add an absolute path based on first path segment (the repo name on GitHub Pages)
    try {
      var parts = location.pathname.split("/").filter(Boolean);
      if (parts.length > 0) {
        var repo = "/" + parts[0];
        candidates.push(repo + "/state/events.json");
      }
    } catch (e) { /* no-op */ }

    // Ensure uniqueness
    var u = {};
    var out = [];
    for (var i = 0; i < candidates.length; i++) {
      var p = candidates[i];
      if (!u[p]) { u[p] = true; out.push(p); }
    }
    return out;
  }

  function fetchFirst(paths, done) {
    if (!paths.length) { done(new Error("No valid paths to try")); return; }
    var p = paths[0];
    fetch(p, { cache: "no-store" }).then(function (r) {
      if (!r.ok) throw new Error("HTTP " + r.status + " for " + p);
      return r.json();
    }).then(function (j) {
      done(null, j, p);
    }).catch(function () {
      fetchFirst(paths.slice(1), done);
    });
  }

  function normalizeStoreToArray(storeObj) {
    // store is an object keyed by composite key; use values
    var arr = [];
    for (var k in storeObj) {
      if (Object.prototype.hasOwnProperty.call(storeObj, k)) {
        arr.push(storeObj[k]);
      }
    }
    return arr;
  }

  function init() {
    setStatus("Loading events…");
    var paths = guessPaths();
    fetchFirst(paths, function (err, json, usedPath) {
      if (err) {
        setStatus("Failed to load events.json (" + err.message + ")");
        tableBody.innerHTML = "<tr><td colspan='5'>Could not load <code>state/events.json</code>. Check that your GitHub Pages artifact includes the <code>state</code> folder and that paths are correct.</td></tr>";
        return;
      }
      try {
        allEvents = normalizeStoreToArray(json);
      } catch (e) {
        setStatus("Loaded events but could not read them.");
        return;
      }
      populateSources();
      applyFilters();
      // keep user params in sync when they change the selector
      sourceSelect.addEventListener("change", function () {
        var params = new URLSearchParams(location.search);
        if (sourceSelect.value === "*" ) { params.delete("source"); }
        else { params.set("source", sourceSelect.value); }
        var newUrl = location.pathname + "?" + params.toString();
        history.replaceState(null, "", newUrl);
        applyFilters();
      });
      qInput.addEventListener("input", function () { applyFilters(); });
      setStatus("Loaded " + allEvents.length + " events from " + usedPath + ". Use the Source filter to narrow the list.");
    });
  }

  document.addEventListener("DOMContentLoaded", init);
}());
</script>
</body>
</html>
